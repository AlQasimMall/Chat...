<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق المكالمات المباشرة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #7C4DFF;
            --secondary-color: #5C6BC0;
            --success-color: #4CAF50;
            --danger-color: #f44336;
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .room-header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .room-title {
            font-size: 24px;
            color: var(--primary-color);
            margin: 0;
        }

        .users-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .user-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s ease;
            cursor: pointer;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary-color);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            margin: 0;
        }

        .user-status {
            font-size: 14px;
            color: #666;
        }

        .user-status.online {
            color: var(--success-color);
        }

        .call-interface {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 1000;
        }

        .video-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #remote-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #local-video {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 180px;
            height: 240px;
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.3);
            object-fit: cover;
            cursor: move;
        }

        .call-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .call-title {
            font-size: 20px;
            margin: 0;
        }

        .call-duration {
            font-size: 16px;
            color: rgba(255,255,255,0.8);
        }

        .call-controls {
            position: absolute;
            bottom: 40px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
        }

        .control-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-button:hover {
            transform: scale(1.1);
            background: rgba(255,255,255,0.3);
        }

        .control-button.active {
            background: var(--primary-color);
        }

        .control-button.danger {
            background: var(--danger-color);
        }

        .control-button.danger:hover {
            background: #d32f2f;
        }

        .incoming-call {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            z-index: 1001;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .incoming-call-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .caller-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: var(--primary-color);
        }

        .caller-info h3 {
            margin: 0;
            font-size: 18px;
        }

        .caller-info p {
            margin: 5px 0 0;
            color: #666;
            font-size: 14px;
        }

        .incoming-call-buttons {
            display: flex;
            gap: 10px;
        }

        .accept-call,
        .reject-call {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .accept-call {
            background: var(--success-color);
            color: white;
        }

        .reject-call {
            background: var(--danger-color);
            color: white;
        }

        .accept-call:hover,
        .reject-call:hover {
            transform: scale(1.05);
        }

        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideUp 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .login-title {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(124, 77, 255, 0.25);
        }

        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="login-screen" class="login-container">
        <h2 class="login-title">تسجيل الدخول</h2>
        <div class="mb-3">
            <label class="form-label">اسم المستخدم</label>
            <input type="text" class="form-control" id="username-input">
        </div>
        <button onclick="login()" class="btn btn-primary w-100">دخول</button>
    </div>

    <!-- شاشة الغرفة -->
    <div id="room-screen" class="container" style="display: none;">
        <div class="room-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="room-title">الغرفة العامة</h2>
                <div class="d-flex align-items-center gap-3">
                    <span class="user-status online">
                        <i class="fas fa-circle me-2"></i>
                        متصل
                    </span>
                    <button onclick="logout()" class="btn btn-outline-danger">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        خروج
                    </button>
                </div>
            </div>
        </div>

        <div class="users-container" id="users-list">
            <!-- سيتم إضافة المستخدمين هنا -->
        </div>
    </div>

    <!-- واجهة المكالمة -->
    <div class="call-interface" id="call-interface">
        <div class="call-header">
            <h3 class="call-title" id="call-title">مكالمة مع محمد</h3>
            <div class="call-duration" id="call-duration">00:00</div>
        </div>

        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
            
            <div class="call-controls">
                <button class="control-button" onclick="toggleMic()" id="mic-btn">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="control-button" onclick="toggleCamera()" id="camera-btn">
                    <i class="fas fa-video"></i>
                </button>
                <button class="control-button danger" onclick="endCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة المكالمة الواردة -->
    <div class="incoming-call" id="incoming-call">
        <div class="incoming-call-header">
            <div class="caller-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="caller-info">
                <h3 id="caller-name">محمد</h3>
                <p>مكالمة فيديو واردة...</p>
            </div>
        </div>
        <div class="incoming-call-buttons">
            <button class="accept-call" onclick="acceptCall()">
                <i class="fas fa-phone me-2"></i>
                قبول
            </button>
            <button class="reject-call" onclick="rejectCall()">
                <i class="fas fa-phone-slash me-2"></i>
                رفض
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- WebRTC adapter -->
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // متغيرات التطبيق
        let currentUser = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentCall = null;
        let callTimer = null;

        const servers = {
            iceServers: [
                {
                    urls: [
                        'stun:stun1.l.google.com:19302',
                        'stun:stun2.l.google.com:19302'
                    ]
                }
            ]
        };

        // دالة تسجيل الدخول
async function login() {
    const username = document.getElementById('username-input').value;
    if (!username) {
        alert('الرجاء إدخال اسم المستخدم');
        return;
    }

    currentUser = {
        id: generateUserId(),
        name: username,
        status: 'online'
    };

    // تسجيل المستخدم في Firebase
    await database.ref(`users/${currentUser.id}`).set(currentUser);
    await database.ref(`users/${currentUser.id}`).onDisconnect().remove();

    // إظهار شاشة الغرفة
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('room-screen').style.display = 'block';

    // بدء مراقبة المستخدمين والمكالمات
    setupUserListeners();
    setupCallListeners();
}

// إنشاء معرف فريد للمستخدم
function generateUserId() {
    return Math.random().toString(36).substr(2, 9);
}

// مراقبة المستخدمين المتصلين
function setupUserListeners() {
    const usersRef = database.ref('users');
    
    usersRef.on('child_added', snapshot => {
        const user = snapshot.val();
        if (user.id !== currentUser.id) {
            addUserToList(user);
        }
    });

    usersRef.on('child_removed', snapshot => {
        const user = snapshot.val();
        removeUserFromList(user);
    });
}

// إضافة مستخدم للقائمة
function addUserToList(user) {
    const usersList = document.getElementById('users-list');
    const userCard = document.createElement('div');
    userCard.className = 'user-card';
    userCard.id = `user-${user.id}`;
    userCard.onclick = () => startCall(user);

    userCard.innerHTML = `
        <div class="user-avatar">
            <i class="fas fa-user"></i>
        </div>
        <div class="user-info">
            <h3 class="user-name">${user.name}</h3>
            <span class="user-status online">
                <i class="fas fa-circle"></i>
                متصل
            </span>
        </div>
    `;

    usersList.appendChild(userCard);
}

// إزالة مستخدم من القائمة
function removeUserFromList(user) {
    const userElement = document.getElementById(`user-${user.id}`);
    if (userElement) {
        userElement.remove();
    }
}

// بدء مكالمة
async function startCall(targetUser) {
    try {
        // إنشاء اتصال WebRTC
        await setupPeerConnection();

        // إرسال طلب المكالمة
        currentCall = {
            from: currentUser.id,
            to: targetUser.id,
            type: 'video',
            status: 'calling',
            timestamp: Date.now()
        };

        await database.ref(`calls/${targetUser.id}`).set(currentCall);
        
        // إظهار واجهة المكالمة
        document.getElementById('call-title').textContent = `مكالمة مع ${targetUser.name}`;
        document.getElementById('call-interface').style.display = 'flex';

        // بدء عداد المكالمة
        startCallTimer();

    } catch (error) {
        console.error('Error starting call:', error);
        alert('حدث خطأ في بدء المكالمة');
    }
}

// إعداد اتصال WebRTC
async function setupPeerConnection() {
    // طلب إذن الوصول للكاميرا والميكروفون
    localStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true
    });

    document.getElementById('local-video').srcObject = localStream;

    peerConnection = new RTCPeerConnection(servers);

    // إضافة المسارات المحلية
    localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
    });

    // إعداد المسار البعيد
    peerConnection.ontrack = event => {
        remoteStream = event.streams[0];
        document.getElementById('remote-video').srcObject = remoteStream;
    };

    // معالجة مرشحات ICE
    peerConnection.onicecandidate = event => {
        if (event.candidate && currentCall) {
            database.ref(`calls/${currentCall.to}/candidates`).push(event.candidate.toJSON());
        }
    };

    return peerConnection;
}

// مراقبة المكالمات الواردة
function setupCallListeners() {
    database.ref(`calls/${currentUser.id}`).on('value', async snapshot => {
        const call = snapshot.val();
        if (!call) return;

        if (call.status === 'calling') {
            // عرض نافذة المكالمة الواردة
            showIncomingCall(call);
        }
    });
}

// عرض نافذة المكالمة الواردة
async function showIncomingCall(call) {
    const caller = await database.ref(`users/${call.from}`).get();
    const callerData = caller.val();

    document.getElementById('caller-name').textContent = callerData.name;
    document.getElementById('incoming-call').style.display = 'block';

    // تشغيل نغمة الرنين
    playRingtone();
}

// قبول المكالمة
async function acceptCall() {
    try {
        const call = await database.ref(`calls/${currentUser.id}`).get();
        const callData = call.val();

        // إعداد الاتصال
        await setupPeerConnection();

        // إرسال الإجابة
        const answer = await peerConnection.createAnswer();
        await peerConnection.setLocalDescription(answer);
        
        await database.ref(`calls/${callData.from}/answer`).set(answer);
        
        // إخفاء نافذة المكالمة الواردة
        document.getElementById('incoming-call').style.display = 'none';
        
        // إظهار واجهة المكالمة
        document.getElementById('call-interface').style.display = 'flex';

        // بدء عداد المكالمة
        startCallTimer();

    } catch (error) {
        console.error('Error accepting call:', error);
        alert('حدث خطأ في قبول المكالمة');
    }
}

// رفض المكالمة
async function rejectCall() {
    const call = await database.ref(`calls/${currentUser.id}`).get();
    const callData = call.val();

    await database.ref(`calls/${callData.from}`).update({
        status: 'rejected'
    });

    document.getElementById('incoming-call').style.display = 'none';
    stopRingtone();
}

// التحكم في المكالمة
function toggleMic() {
    const audioTrack = localStream.getAudioTracks()[0];
    audioTrack.enabled = !audioTrack.enabled;
    document.getElementById('mic-btn').classList.toggle('active');
}

function toggleCamera() {
    const videoTrack = localStream.getVideoTracks()[0];
    videoTrack.enabled = !videoTrack.enabled;
    document.getElementById('camera-btn').classList.toggle('active');
}

// إنهاء المكالمة
async function endCall() {
    if (currentCall) {
        await database.ref(`calls/${currentCall.to}`).remove();
    }

    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }

    if (peerConnection) {
        peerConnection.close();
    }

    stopCallTimer();
    document.getElementById('call-interface').style.display = 'none';
}

// عداد المكالمة
let callDuration = 0;
function startCallTimer() {
    callTimer = setInterval(() => {
        callDuration++;
        const minutes = Math.floor(callDuration / 60);
        const seconds = callDuration % 60;
        document.getElementById('call-duration').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
}

function stopCallTimer() {
    if (callTimer) {
        clearInterval(callTimer);
        callTimer = null;
        callDuration = 0;
    }
}

// تسجيل الخروج
async function logout() {
    if (currentUser) {
        await database.ref(`users/${currentUser.id}`).remove();
        currentUser = null;
    }
    window.location.reload();
}

// عند تحميل الصفحة
window.onload = () => {
    // التحقق من دعم WebRTC
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert('متصفحك لا يدعم مكالمات الفيديو');
        return;
    }
};
    </script>
</body>
</html>
